---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import MarqueeBanner from '../components/MarqueeBanner.astro';

// Expanded Testimonials Data - Updated for current services
const allReviews = [
  {
    initial: 'M',
    name: 'María G.',
    service: 'Tratamiento de Candidiasis',
    review: 'Llevaba meses con candidiasis recurrente. Aquí por fin encontré un tratamiento que funcionó de verdad.'
  },
  {
    initial: 'L',
    name: 'Lucía M.',
    service: 'Descarte de VPH',
    review: 'Me detectaron VPH a tiempo gracias a su prueba molecular. Hoy estoy en tratamiento y tranquila.'
  },
  {
    initial: 'C',
    name: 'Carolina R.',
    service: 'Infecciones Vaginales',
    review: 'Tenía vergüenza de hablar de mis síntomas, pero aquí me escucharon sin juzgar y me dieron la solución.'
  },
  {
    initial: 'A',
    name: 'Andrea P.',
    service: 'Despistaje de ITS',
    review: 'Rápido, confidencial y sin drama. Me hicieron todos los exámenes y tuve resultados en pocos días.'
  },
  {
    initial: 'V',
    name: 'Valeria S.',
    service: 'Tratamiento Lesiones Íntimas',
    review: 'Tenía unas verrugas que me daban mucha pena. El tratamiento fue efectivo y el seguimiento excelente.'
  },
  {
    initial: 'D',
    name: 'Diana F.',
    service: 'Vacuna VPH',
    review: 'Me explicaron todo sobre la vacuna y me la aplicaron sin problema. Prevenir es mejor que lamentar.'
  }
];
---

<BaseLayout
  title="Testimonios | Pacientes Zygo en Cusco y Perú"
  description="Historias reales de pacientes de Zygo en Cusco. Tratamientos de candidiasis, VPH e infecciones vaginales con resultados."
>
  <Header />

  <main class="testimonials-page">
    
    <!-- HEADER SECTION -->
    <!-- HERO SECTION -->
    <section class="hero-section">
      <div class="hero-section__content" data-animate>
        <span class="badge-pill">#VOCES ZYGO</span>
        <h1 class="hero-section__title">
          Historias Reales de<br/>
          <span class="hero-section__title-italic">Mujeres Reales</span>
        </h1>
        <p class="hero-section__desc">
          La confianza se construye con experiencias. Aquí compartimos lo que nuestras pacientes dicen sobre su paso por Zygo.
        </p>
      </div>
    </section>

    <!-- INTERACTIVE HORIZONTAL SCROLL CAROUSEL -->
    <section class="gsap-horizontal-section" id="horizontalSection">
      <div class="gsap-horizontal-track" id="horizontalTrack">
        
        <!-- Review Cards -->
        {allReviews.map((review) => (
          <div class="gsap-card review-card">
            <div class="review-card__header">
              <div class="review-card__initial">{review.initial}</div>
              <div class="review-card__meta">
                <h3>{review.name}</h3>
                <span>{review.service}</span>
              </div>
            </div>
            <p class="review-card__body">"{review.review}"</p>
            <div class="review-card__stars">★★★★★</div>
          </div>
        ))}

        <!-- End Card -->
        <div class="gsap-card cta-card">
          <h2>Únete a nuestra <br/>comunidad</h2>
          <a href="/contacto" class="btn-circle">
            Agendar
          </a>
        </div>

      </div>
    </section>

    <!-- GRID SECTION FOR MOBILE / EXTRA CONTENT -->
    <section class="section">
      <div class="container mobile-grid-container">
        <div class="section-header text-center">
          <h2 class="title-serif">Más Experiencias</h2>
        </div>
        <div class="reviews-grid-mobile">
          {allReviews.slice(0, 4).map((review) => (
             <article class="mobile-review-card">
                <div class="review-card__initial small">{review.initial}</div>
                <p>"{review.review}"</p>
                <strong>- {review.name}</strong>
             </article>
          ))}
        </div>
      </div>
    </section>

    <MarqueeBanner text="CONFIA EN ZYGO" speed={30} />

  </main>
</BaseLayout>

<style>
  .testimonials-page {
    overflow-x: hidden;
  }

  /* HEADER */
  /* HERO SECTION (Standardized) */
  .hero-section {
    position: relative;
    padding: 10rem 0 11.7rem;
    text-align: center;
    background: linear-gradient(-90deg, #FCA4BD 0%, #FCE3F2 50%, #ffffff 100%);
  }

  .hero-section__content {
    position: relative;
    z-index: 1;
    max-width: 800px;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  /* Badge Pill - Standard */
  .badge-pill {
    display: inline-block;
    padding: 10px 16px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 24px;
    font-size: 12px;
    font-weight: 700;
    line-height: 12px;
    color: var(--zygo-guinda);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background: transparent; /* Transparent in hero */
    border: none; /* No border in hero usually per acerca-de override, but let's stick to standard pill base */
  }

  /* Override specific to hero if needed per acerca-de: */
  .hero-section .badge-pill {
    background: transparent;
    border: none;
  }

  .hero-section__title {
    font-family: 'Manrope', sans-serif;
    font-size: clamp(2.5rem, 5vw, 58px);
    font-weight: 500;
    line-height: 1.08;
    color: var(--text-dark);
    margin-top: 0.5rem;
  }

  .hero-section__title-italic {
    display: block;
    font-family: 'Playfair Display', Georgia, serif;
    font-style: italic;
    font-weight: 400;
  }

  .hero-section__desc {
    margin-top: 1.5rem;
    font-size: 1.125rem;
    color: var(--text-gray);
    line-height: 1.6;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  /* HORIZONTAL SCROLL SECTION */
  .gsap-horizontal-section {
    position: relative;
    height: 100vh; /* Takes full viewport initially, pinned by GSAP */
    width: 100vw;
    overflow: hidden;
    background: #ffffff; /* Clean White Background */
    display: flex;
    align-items: center;
    visibility: visible;
  }

  /* Make visible immediately via JS or fallback */
  :global(html.js) .gsap-horizontal-section {
     visibility: visible;
  }

  /* Only show horizontal scroll on desktop/tablet initially, 
     but we will use GSAP matchMedia to disable/enable */
  .gsap-horizontal-track {
    display: flex;
    gap: 5rem; /* Increased gap for more space */
    padding: 0 5vw; /* Start content earlier since intro is gone */
    width: max-content; /* Important: width based on content */
    height: 100%;
    align-items: center;
  }

  .gsap-card {
    width: 450px; /* Wider cards */
    height: 550px; /* Taller cards */
    background: var(--white);
    border: 1px solid rgba(0,0,0,0.05); /* Subtle border for definition */
    border-radius: 2rem;
    padding: 4rem;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.08); /* Softer shadow */
    transition: transform 0.3s ease;
  }

  /* Removed intro styles as element is deleted */

  /* Review Card Styling */
  .review-card__header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .review-card__initial {
    width: 60px;
    height: 60px;
    background: var(--zygo-guinda);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Playfair Display', serif;
    font-size: 1.8rem;
    font-weight: 700;
  }

  .review-card__meta h3 {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--primary-color);
    margin: 0;
  }

  .review-card__meta span {
    font-size: 0.9rem;
    color: var(--text-gray);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .review-card__body {
    font-size: 1.15rem;
    line-height: 1.6;
    color: var(--text-dark);
    font-style: italic;
    margin-bottom: auto; /* Push stars to bottom */
  }

  .review-card__stars {
    color: #FFB400;
    font-size: 1.5rem;
    margin-top: 2rem;
  }

  /* CTA Card */
  .cta-card {
    background: #FFB4B4; /* Soft Pink */
    background: linear-gradient(135deg, #FFB4B4 0%, #FFE2E2 100%);
    align-items: center;
    text-align: center;
  }

  .cta-card h2 {
    font-family: 'Playfair Display', serif;
    font-size: 2.5rem;
    color: var(--primary-color);
    margin-bottom: 2rem;
  }

  .btn-circle {
    width: 120px;
    height: 120px;
    background: var(--primary-color);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    font-weight: 700;
    font-size: 1.1rem;
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  .btn-circle:hover {
    transform: scale(1.1) rotate(5deg);
  }

  /* MOBILE GRID (Visible only on small screens) */
  .mobile-grid-container {
    display: none;
    padding-top: 4rem;
    padding-bottom: 4rem;
  }

  .reviews-grid-mobile {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
    margin-top: 2rem;
  }

  .mobile-review-card {
    background: white;
    padding: 2rem;
    border-radius: 1rem;
    box-shadow: var(--shadow-sm);
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .review-card__initial.small {
    width: 40px;
    height: 40px;
    font-size: 1.2rem;
  }

  /* GSAP Logic will handle visibility toggle via specific classes/styles if needed, 
     but media queries are safer for layout shifts */

  @media (max-width: 1024px) {
    /* On tablet/mobile, disable the pinning section visually or adjust */
    /* For simplicity in this implementation, we will hide horizontal section on mobile
       and show grid instead. GSAP matchMedia will prevent logic execution. */
    
    .gsap-horizontal-section {
      display: none;
    }

    .mobile-grid-container {
      display: block;
    }
  }
</style>

<script>
  import gsap from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  let ctx: gsap.Context | null = null; // Store GSAP context

  function initTestimonialsHorizontal() {
    const section = document.getElementById('horizontalSection');
    const track = document.getElementById('horizontalTrack');

    if (!section || !track) return;

    // cleanup previous context if exists (safety check)
    if (ctx) ctx.revert();
    
    const mainWrapper = document.querySelector('.testimonials-page'); // GSAP Scope
    
    ctx = gsap.context(() => {
      // Use MatchMedia for responsive interactive logic
      let mm = gsap.matchMedia();

      mm.add("(min-width: 1024px)", () => {
        // Logic for Desktop: Horizontal Scroll
        const getScrollAmount = () => -(track.scrollWidth - window.innerWidth);
        
        const tween = gsap.to(track, {
          x: getScrollAmount,
          ease: "none",
        });

        ScrollTrigger.create({
          trigger: section,
          start: "top top",
          end: () => `+=${track.scrollWidth - window.innerWidth}`,
          pin: true,
          animation: tween,
          scrub: 1,
          invalidateOnRefresh: true,
          anticipatePin: 1,
        });

        // Parallax effect for cards inside the track
        const cards = gsap.utils.toArray('.gsap-card');
        cards.forEach((card: any) => {
          gsap.fromTo(card, 
            { scale: 0.9, opacity: 0.8 },
            {
              scale: 1,
              opacity: 1,
              duration: 0.5,
              scrollTrigger: {
                trigger: card,
                containerAnimation: tween,
                start: "left center",
                toggleActions: "play none none reverse",
                horizontal: true
              }
            }
          );
        });
      });

      // --- MOBILE ANIMATION LOGIC ---
      // Single timeline per card: handles full journey (fade in -> visible -> fade out)
      mm.add("(max-width: 1023px)", () => {
        const mobileCards = gsap.utils.toArray('.mobile-review-card');
        
        mobileCards.forEach((card: any) => {
          // Create a single timeline for the entire scroll journey
          const tl = gsap.timeline({
            scrollTrigger: {
              trigger: card,
              start: "top bottom",   // When card top enters the bottom of viewport
              end: "bottom top",     // When card bottom exits the top of viewport
              scrub: 0.5,            // Smooth scrub
            }
          });

          // Timeline sequence: Fade In (50%) -> Full Visible (90%) -> Fade Out (5%)
          tl.fromTo(card, 
            { opacity: 0, y: 40 },
            { opacity: 1, y: 0, duration: 1, ease: "power2.out" }
          )
          .to(card, 
            { opacity: 0, y: -40, duration: 1, ease: "power2.in" }
          );
        });
      });
    }, mainWrapper); // Scope to main wrapper to include mobile grid
  }

  // Initial Load
  initTestimonialsHorizontal();

  // Handle View Transitions
  document.addEventListener('astro:page-load', () => {
    // Re-init on new page load
    initTestimonialsHorizontal();
    // Force refresh to calculate positions correctly after transition
    setTimeout(() => ScrollTrigger.refresh(), 100);
  });

  document.addEventListener('astro:before-swap', () => {
    // Clean up BEFORE the content is swapped
    if (ctx) ctx.revert();
    ScrollTrigger.getAll().forEach(t => t.kill());
  });
</script>
